name: Deploy API to Production

on: [push, pull_request]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Test Docker Compose Build
      run: |
        echo "ğŸ§ª Testing Docker Compose build..."
        
        # Test that docker-compose builds successfully
        docker-compose -f docker-compose.yml build
        
        echo "âœ… Docker Compose build successful"
    
    - name: Test API container
      run: |
        echo "ğŸš€ Testing API container..."
        
        # Build just the API service
        docker-compose -f docker-compose.yml build api
        
        # Run a simple test
        docker-compose -f docker-compose.yml run --rm api python -c "
        import sys
        sys.path.insert(0, '/app')
        try:
            from api.api import app
            print('âœ… API imports successfully')
        except Exception as e:
            print(f'âŒ Error: {e}')
            sys.exit(1)
        "
        
        echo "âœ… API container test passed"
    
    - name: Test entrypoint script
      run: |
        echo "ğŸ”§ Testing entrypoint script..."
        
        # Test the entrypoint script
        docker run --rm \
          -e DVC_USER=test \
          -e DVC_PASSWORD=test \
          $(docker-compose -f docker-compose.yml config | grep 'image:' | head -1 | awk '{print $2}') \
          /entrypoint.sh echo "âœ… Entrypoint script works"
        
        echo "âœ… Entrypoint test passed"