name: Deploy API to Production

on: [push, pull_request]
#  push:
#    branches: [main]
#  pull_request:
#    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Quick validation
      run: |
        echo "ðŸ§ª Validating project structure..."
        # Check essential files exist
        ls -la docker/Dockerfile docker-compose.yml api/api.py
        echo "âœ… Project structure OK"

  deploy:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Docker login
      run: |
        echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
    
    - name: Build Docker image
      run: docker build -f docker/Dockerfile -t xoface-api .
    
    - name: Tag and push
      run: |
        docker tag xoface-api ${{ secrets.DOCKER_USERNAME }}/xoface-api:${{ github.sha }}
        docker tag xoface-api ${{ secrets.DOCKER_USERNAME }}/xoface-api:latest
        
        docker push ${{ secrets.DOCKER_USERNAME }}/xoface-api:${{ github.sha }}
        docker push ${{ secrets.DOCKER_USERNAME }}/xoface-api:latest


#checking CD 