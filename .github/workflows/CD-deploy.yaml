name: Deploy API to Production

on: [push, pull_request]
#  push:
#    branches: [main]
#  pull_request:
#    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Quick validation
      run: |
        echo "ðŸ§ª Validating project structure..."
        # Check essential files exist
        ls -la docker/Dockerfile docker-compose.yml api/api.py
        echo "âœ… Project structure OK"

  deploy:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Docker login
      run: |
        echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
    
    - name: Build Docker image
      run: docker build -f docker/Dockerfile -t xoface-api .
    
    - name: Tag and push
      run: |
        docker tag xoface-api ${{ secrets.DOCKER_USERNAME }}/xoface-api:${{ github.sha }}
        docker tag xoface-api ${{ secrets.DOCKER_USERNAME }}/xoface-api:latest

        docker push ${{ secrets.DOCKER_USERNAME }}/xoface-api:${{ github.sha }}
        docker push ${{ secrets.DOCKER_USERNAME }}/xoface-api:latest

  deploy-to-vm:
    runs-on: ubuntu-latest
    needs: deploy

    steps:
    - name: Deploy to VM via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USER }}
        password: ${{ secrets.VM_PASSWORD }}
        port: 22
        script: |
          echo "Pulling latest image from Docker Hub..."
          docker pull ${{ secrets.DOCKER_USERNAME }}/xoface-api:latest

          echo "Stopping and removing old container..."
          docker stop mlops_xoxo-api 2>/dev/null || true
          docker rm mlops_xoxo-api 2>/dev/null || true

          echo "Starting new container..."
          docker run -d \
            --name mlops_xoxo-api \
            -p 8000:8000 \
            --restart unless-stopped \
            ${{ secrets.DOCKER_USERNAME }}/xoface-api:latest

          echo "Verifying container is running..."
          docker ps | grep mlops_xoxo-api

          echo "Cleaning up old images..."
          docker image prune -f

          echo "Deployment completed successfully!"
