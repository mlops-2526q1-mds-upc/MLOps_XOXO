name: Train Face Embedding Model

on: [push, pull_request]

jobs:
  train:
    runs-on: ubuntu-latest
    
    steps:

    
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: '3.13'
    
    - name: Install
      run: |
        pip install torch dvc dvc-http
        pip install -e .
    
    - name: Setup DVC
      env:
        DAGSHUB_USER: ${{ secrets.DAGSHUB_DVC_USER }}
        DAGSHUB_PASS: ${{ secrets.DAGSHUB_DVC_PASS }}
      run: |
        dvc remote modify origin auth basic
        dvc remote modify origin user "$DAGSHUB_USER"
        dvc remote modify origin password "$DAGSHUB_PASS"
    
    - name: Download face embedding data + models with retry
      run: |
        echo "ðŸ“¥ Downloading face embedding models with retry logic..."
        
        # Function to download with retries
        download_with_retry() {
          local file=$1
          local max_attempts=6
          local attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt to download: $file"
            if dvc pull "$file"; then
              echo "âœ… Successfully downloaded: $file"
              return 0
            else
              echo "âš ï¸ Attempt $attempt failed for: $file"
              if [ $attempt -eq $max_attempts ]; then
                echo "âŒ All attempts failed for: $file"
                return 1
              fi
              echo "ðŸ”„ Retrying in 5 seconds..."
              sleep 5
              ((attempt++))
            fi
          done
        }
        
        # Check disk space before downloading
        echo "ðŸ“Š Disk space before download:"
        df -h
        
        # Download only specific files, not directories
        download_with_retry "models/face_embedding/mobilenetv2_arcface_model.pth"
        download_with_retry "data/processed/face_embedding/faces.pkl" || echo "âš ï¸ Faces data download failed, continuing..."
        download_with_retry "data/external/casioface/train.idx" || echo "âš ï¸ External data download failed, continuing..."
        download_with_retry "data/external/casioface/train.lst" || echo "âš ï¸ External data download failed, continuing..."
        download_with_retry "data/external/casioface/train.rec" || echo "âš ï¸ External data download failed, continuing..."
        
        echo "âœ… Download attempts completed"
        
        # Check disk space after
        echo "ðŸ“Š Disk space after download:"
        df -h
        
        # Verify downloaded files
        if [ -f "models/face_embedding/mobilenetv2_arcface_model.pth" ]; then
          echo "âœ… Model file exists: $(du -h models/face_embedding/mobilenetv2_arcface_model.pth)"
        else
          echo "âŒ Model file not found!"
          exit 1
        fi
    
    - name: Train without DVC repro
      run: |
        # Update params for CI
        python -c "
        import yaml
        with open('pipelines/face_embedding/params.yaml') as f:
            p = yaml.safe_load(f)
        p['training']['epochs'] = 1
        p['training']['device'] = 'cpu'
        with open('pipelines/face_embedding/params.yaml', 'w') as f:
            yaml.dump(p, f)
        print('Training for 1 epoch')
        "
        
        # Run the training script directly, not through dvc repro
        python pipelines/face_embedding/train.py


    #- name: Set 50 epochs and train
    #  run: |
    #    # Update params
    #    python -c "
    #    import yaml
    #    with open('pipelines/face_embedding/params.yaml') as f:
    #        p = yaml.safe_load(f)
    #    p['training']['epochs'] = 1  # Keep at 1 for CI
    #    p['training']['device'] = 'cpu'
    #    p['training']['batch_size'] = 4  # Reduce batch size for memory
    #    p['training']['num_workers'] = 0  # Disable multiprocessing
    #    with open('pipelines/face_embedding/params.yaml', 'w') as f:
    #        yaml.dump(p, f)
    #    print('Training for 1 epoch (CI)')
    #    "
    #    
    #    # Run just the train stage
    #    dvc repro pipelines/face_embedding/dvc.yaml
    #    
    #    # Clean up after training
    #    rm -rf .dvc/tmp 2>/dev/null || true
    #    echo "ðŸ“Š Final disk space:"
    #    df -h